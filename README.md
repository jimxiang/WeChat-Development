# WeChat-Development
#### 微信公众号开发
---
微信是一个神奇的app，使用量超过中国总人口的一半，这么大的市场怎么会缺少商机？除了日常的聊天、发朋友圈，看公众号也是微信用户特别喜欢做的事情，随着微商的火热，很多用户都渴望拥有一个定制化的公众号，这就需要大量会开发公众号的程序员，商机出现！web技术越来越火热，也越来越重要，微信公众号本质上也是web开发，所以对web开发者来说，会微信公众号开始是一种基本素养。
#### 1.开发准备
##### 1.服务器和域名
当然有自己的服务器和域名的伙伴不用考虑太多。如果没有，简单起见，推荐使用**ngrok-sunny**来做内网转发。**ngrok-sunny**提供免费的ngrok.cc域名，并且可以自定义主域名(即三级域名)，通过这个工具可以把本地服务器映射到公网，十分利于微信公众号的开发。这个工具的使用可以参见[官网](https://www.ngrok.cc/)。
##### 2.服务器配置
在微信公众平台的服务器配置页面里填入我们自己的服务器Url、token，进行服务器校验，这是一个微信服务器连接我们自己的服务器的过程。网页上会有是否配置成功的提示。配置成功后，进入下一步。
##### 3.服务器校验
微信服务器会发送一个**get**请求到我们的服务器，我们通过这个**get**请求进行服务器校验，微信服务器会向你发送校验用到的所有参数：signature、nonce、timestamp和echostr，拿到这些参数后，我们要利用服务器配置中自定义的token，参数timestamp和nonce进行字典排序，然后连接成一个字符串，再对这份字符串进行**sha1**加密：
```javascript
sha1([token, timestamp, nonce].sort().join(''));
```
最后通过比较我们得到的加密后的字符串是否和signature相等来作为校验的依据，如果相等，则校验成功，我们返回**echostr**即可。
##### 4.access_token
使用微信公众号接口需要提供唯一的票据：**access_token**，
微信提供了一个获取access_token的接口，需要我们传入**appid**和**appsecret**，**appid**在我们申请公众号的时候就有了，**appsecret**在配置服务器的页面手动生成。access_token有**7200秒**的失效时间，而且接口每天有调用次数限制，所以要对access_token做全局的管理，避免过度请求浪费调用次数。
##### 5.XML解析与封装
当微信用户向微信发消息或者我们向用户返回消息时微信服务器发送和接收的数据都是XML格式的，所以我们接收到消息时要进行XML解析，回复消息时要把数据组装为XML格式，这个过程可以统一来做，我们需要写解析和组装XML格式的公共方法。
##### 6.消息回复
消息回复可以分为主动回复和被动回复，当用户关注公众号后发送的引导消息就是被动回复，对用户的输入做特性化的回复就是主动回复。用户在公众号内的点击、输入等事件都会触发微信服务器向我们的服务器发送消息数据包，数据包里包含了用户的openid、事件类型等，根据这些数据我们可以作出有针对性的回复。
##### 7.接口调用
调用微信的接口是开发公众号最重要的工作了，在打通了access_token这一关后，接口调用的工作就变得很简单了，我们只需要按照官方文档进行调用就好。
##### 8.JSSDK的使用
公众里提供的功能很有限，很多重要的业务都需要依靠网页来做，JSSDK为微信内网页提供了强大的功能：分享、音频、视频、摇一摇、卡券、支付等。使用JSSDK也需要配置服务器，填入Url，然后最重要的工作就是获取和验证ticket，这个过程和access_token有些相似。获取ticket需要使用access_token，然后使用ticket与页面Url进行校验，检验的过程比较繁琐，首先生成一个16位的随机数字符串，然后获取当前时间戳，最后加密，
```javascript
nonce = Math.random().toString(36).substr(2, 15);
timestamp = parseInt(new Date().getTime() / 1000, 10) + '';
str = [
    'noncestr=' + nonceStr,
    'jsapi_ticket=' + ticket,
    'timestamp=' + timestamp,
    'url=' + url
    ].sort().join('&');
signature = (crypto.createHash('sha1')).update(str).digest('hex');
```
返回nonceStr、timestamp和signature到页面js中进行校验，校验前需要进入JSSDK需要的外部js文件，然后使用**wx.config()**方法进行校验，在**config**方法中会传入这个需要页面使用的功能名称，校验成功后，该页面就可以使用这些功能了。


---
以上就是开发微信公众号的大致流程，搞定校验工作和接口调用工作后，就可以“随心所欲”的进行开发了。